name: Diff Triggers
description: Check if changed files match trigger paths. Returns true if any trigger matches, false otherwise. Always returns true if triggers are omitted.
branding:
  icon: package
  color: blue

inputs:
  ### Required
  # Nothing!

  ### Typical / recommended
  triggers:
    description: Paths used to trigger an event; e.g. ('./backend/' './frontend/); always trigger if omitted

  ### Usually a bad idea / not recommended
  ref:
    description: Reference to compare against (e.g., 'main', 'HEAD^', commit SHA). Defaults to base repo default branch for PRs, or HEAD^ for non-PR events. Local refs (HEAD^, HEAD~2) work for non-PR events; remote refs (branches, tags, SHAs) work for all events
    required: false

outputs:
  triggered:
    description: Boolean result of triggers
    value: ${{ steps.diff.outputs.triggered }}

runs:
  using: composite
  steps:
    # Checkout appropriate ref based on event type
    - uses: actions/checkout@v6
      with:
        repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
        ref: ${{ github.event.pull_request.head.sha || github.ref }}
        # Fetch all commits for non-PR events (defaults to 1 for PRs)
        fetch-depth: ${{ github.event.pull_request && 1 || 0 }}

    - shell: bash
      id: diff
      run: |
        # Diff for changes
        set -e

        # Always fire if triggers are omitted
        if [ -z "${{ inputs.triggers }}" ]; then
          echo ""
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║  DIFF TRIGGERS: TRIGGERED (always, triggers omitted)       ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          echo "::notice::Diff Triggers fired! ${{ github.repository }} — ${{ github.workflow }} / ${{ github.job }}"
          echo "triggered=true" >> $GITHUB_OUTPUT

          # Step summary
          {
            echo "### ✅ Diff Triggers — TRIGGERED"
            echo ""
            echo "| Detail | Value |"
            echo "|--------|-------|"
            echo "| **Workflow / Job** | \`${{ github.workflow }}\` / \`${{ github.job }}\` |"
            echo "| **Triggers** | _(omitted — always fires)_ |"
            echo "| **Result** | \`triggered=true\` |"
          } >> $GITHUB_STEP_SUMMARY

          exit 0
        fi

        # Build if changed files (git diff) match triggers
        # Parse triggers input into array (properly handles quoted strings with spaces)
        TRIGGERS_STR="${{ inputs.triggers }}"
        # Extract all quoted strings preserving spaces within quotes
        TRIGGERS=()
        while IFS= read -r line; do
          [[ -n "$line" ]] && TRIGGERS+=("$line")
        done < <(grep -o "'[^']*'" <<< "$TRIGGERS_STR" | sed "s/'//g")

        # Determine reference to compare against
        # PR events: default to base repo default branch if ref omitted
        # Non-PR events: default to HEAD^ if ref omitted
        BASE_REF="${{ inputs.ref || github.event.pull_request.base.repo.default_branch || 'HEAD^' }}"
        git remote add base "${{ github.event.pull_request.base.repo.clone_url || github.event.repository.clone_url }}"
        
        # If BASE_REF starts with HEAD, it's a local ref - use it directly
        # Otherwise, fetch from remote and prefix
        if [[ "$BASE_REF" == HEAD* ]]; then
          COMPARE_REF="$BASE_REF"
        else
          git fetch base "$BASE_REF"
          COMPARE_REF="base/$BASE_REF"
        fi

        # Log configuration
        echo ""
        echo "::group::Diff Triggers — Configuration"
        echo "  Triggers:     $TRIGGERS_STR"
        echo "  Comparing to: $COMPARE_REF (ref: $BASE_REF)"
        echo "  Event:        ${{ github.event_name }}"
        echo "::endgroup::"

        # Check ALL triggers and collect results for comprehensive reporting
        TRIGGERED=false
        MATCHED_TRIGGERS=()
        ALL_MATCHED_FILES=""
        DETAILS_LOG=""
        SUMMARY_FILES_MD=""

        for t in "${TRIGGERS[@]}"; do
          DIFF_OUTPUT=$(git diff "$COMPARE_REF" --name-only -- "$t")
          if [[ -n "$DIFF_OUTPUT" ]]; then
            TRIGGERED=true
            MATCHED_TRIGGERS+=("$t")
            ALL_MATCHED_FILES+="$DIFF_OUTPUT"$'\n'
            DETAILS_LOG+="  ✔ Trigger '$t' — MATCHED"$'\n'
            while IFS= read -r f; do
              DETAILS_LOG+="      $f"$'\n'
              SUMMARY_FILES_MD+="| \`$f\` | \`$t\` |"$'\n'
            done <<< "$DIFF_OUTPUT"
          else
            DETAILS_LOG+="  ✘ Trigger '$t' — no matches"$'\n'
          fi
        done

        # Display results in a collapsible group
        echo "::group::Diff Triggers — Trigger Details"
        echo "$DETAILS_LOG"
        echo "::endgroup::"

        # Prominent banner in the log
        echo ""
        if [[ "$TRIGGERED" == "true" ]]; then
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║  DIFF TRIGGERS: TRIGGERED (true)                           ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          MATCHED_LIST=$(IFS=', '; echo "${MATCHED_TRIGGERS[*]}")
          echo "  Matching triggers: $MATCHED_LIST"
          echo ""
          echo "::notice::Diff Triggers fired! ${{ github.repository }} — ${{ github.workflow }} / ${{ github.job }}"
          echo "triggered=true" >> $GITHUB_OUTPUT

          # Step summary
          {
            echo "### ✅ Diff Triggers — TRIGGERED"
            echo ""
            echo "| Detail | Value |"
            echo "|--------|-------|"
            echo "| **Workflow / Job** | \`${{ github.workflow }}\` / \`${{ github.job }}\` |"
            echo "| **Triggers** | \`$TRIGGERS_STR\` |"
            echo "| **Comparing to** | \`$COMPARE_REF\` |"
            echo "| **Result** | \`triggered=true\` |"
            echo ""
            echo "<details><summary>Changed files matching triggers</summary>"
            echo ""
            echo "| File | Trigger |"
            echo "|------|---------|"
            echo "$SUMMARY_FILES_MD"
            echo "</details>"
          } >> $GITHUB_STEP_SUMMARY
        else
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║  DIFF TRIGGERS: NOT TRIGGERED (false)                      ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          echo "::notice::Diff Triggers not fired. ${{ github.repository }} — ${{ github.workflow }} / ${{ github.job }}"
          echo "triggered=false" >> $GITHUB_OUTPUT

          # Step summary
          {
            echo "### ⊘ Diff Triggers — NOT TRIGGERED"
            echo ""
            echo "| Detail | Value |"
            echo "|--------|-------|"
            echo "| **Workflow / Job** | \`${{ github.workflow }}\` / \`${{ github.job }}\` |"
            echo "| **Triggers** | \`$TRIGGERS_STR\` |"
            echo "| **Comparing to** | \`$COMPARE_REF\` |"
            echo "| **Result** | \`triggered=false\` |"
          } >> $GITHUB_STEP_SUMMARY
        fi
